export default class Film_list {
    constructor() {
        this.pageData = {
            //数据库的总数据
            totalCount: 0,
            //当前页面是第几页
            currentPage: 1,
            //总共有多少页
            totalPage: 0,
            //当前页数是多少个数据
            pageSize: 3,
            // 获取电影数据
            films: []
        }
        this.render();
        this.handel();
        this.getfilms();
        this.flip_over();
        $.parser.parse();
    }
    render() {
        const film_list = `
        <div>
            <!-- 新增按钮 -->
            <a id="btn" href="#" class="easyui-linkbutton" data-options="iconCls:'icon-add'">新增</a>
            <!-- 下拉搜索框 -->
            <input id="ss" class="easyui-searchbox" style="width:200px"
                data-options="prompt:'请输入查询内容',menu:'#searchType'"></input>
            <div id="searchType" style="width:150px">
                <div data-options="name:'all'">中文名</div>
                <div data-options="name:'sports'">类型</div>
                <div data-options="name:'sports'">制片国家</div>
                <div data-options="name:'sports'">片长</div>
            </div>
        </div>
        <div id="warp">
        <!--  表 格  -->
        <table id="table">
        </table>
        <!-- 页数 -->
        <div id="page" style="background:#efefef;border:1px solid #ccc;"></div>
        </div>
        `;
        $("#rightPart").html(film_list);
    }
    // 渲染表格
    handel() {
        $('#table').datagrid({
            toolbar: '#toolbar',
            // data: [{
            //         'id': '1', 'images': '0', 'cName': '狂暴凶狮', 'eName': 'Prooi', 'type': '动画',
            //         'country': '荷兰', 'filmLength': '105分钟', 'showtime': '2019/02/20', 'director': '迪克',
            //         'actor': '艾比', 'synopsis': '在阿姆斯特丹...', 'state': '正在热映'
            //     }],
            columns: [[
                { field: '_id', title: '编号', width: 40, align: "center" },
                { field: 'images', title: '图片', width: 100, align: "center" },
                { field: 'cName', title: '中文名', width: 100, align: "center" },
                { field: 'eName', title: '英文名', width: 100, align: "center" },
                { field: 'type1', title: '类型', width: 80, align: "center" },
                { field: 'country', title: '制片国家', width: 80, align: "center" },
                { field: 'filmLength', title: '片长', width: 80, align: "center" },
                { field: 'showtime', title: '上映时间', width: 100, align: "center" },
                { field: 'director', title: '导演', width: 80, align: "center" },
                { field: 'actor', title: '演员', width: 80, align: "center" },
                { field: 'synopsis', title: '简介', width: 150, align: "center" },
                { field: 'state', title: '所属状态', width: 80, align: "center" },
                {
                    field: 'handle', title: '操作', width: 150, align: 'center',
                    formatter: function (value, row, index) {
                        return `
                            <a href="#/system/film_update" class="easyui-linkbutton update" data-id="${row.id}" data-option="iconCls:'icon-pencil'" >修改</a>
                            <a href="#" class="easyui-linkbutton remove" data-id="${row.id}" data-option="iconCls:'icon-remove'">删除</a>
                        `
                    }
                }
            ]],
            onLoadSuccess: function () {
                $.parser.parse('#warp');
            }
        });

    }
    // 获取所有电影 渲染列表
    getfilms() {
        $.ajax({
            url: `/api/film`,
            type: 'GET',
            data: {
                currentPage: this.pageData.currentPage,
                pageSize: this.pageData.pageSize
            },
            success: msg => {
                console.log(msg)
                this.pageData = msg;
                $('#table').datagrid({
                    data: this.pageData.films
                });
                $('#page').pagination({
                    total: this.pageData.totalCount - 0,
                    pageSize: this.pageData.pageSize - 0,
                    pageList: [1, 2, 3, 4],
                    displayMsg: `当前页面是第{from} 条到 {to} 条，数据总计：{total} 条`
                });
            }
        })
    }
    // 翻页
    flip_over() {
        let getfilms = () => {
            this.getfilms();
        }
        // 点击上一页/下一页
        $("#page").pagination({
            onSelectPage: (currentPage, pageSize) => {
                this.pageData.currentPage = currentPage;
                this.pageData.pageSize = pageSize;
                this.getfilms();
            }
        });
        // 点击新增按钮跳转到新增页面
        $("#addBtn").linkbutton({
            onClick: function () {
                location.hash = "#/system/film_add"
            }
        });
        // 删除事件
        $("#rightPart").on("click", ".remove", function () {
            $.messager.defaults = {
                ok: "是",
                cancel: '否',
                width: '350px'
            }
            $.messager.confirm('弹窗', '您确认想要删除此电影吗？', r => {
                let _id = $(this).data("_id");
                if (r) {
                    $.ajax({
                        url: `/api/film/${_id}`,
                        type: "DELETE",
                        success: msg => {
                            if (msg) {
                                $.messager.alert('电影', '删除成功');
                                getfilms();
                            }
                        }
                    })
                }
            });
        })
    }
}